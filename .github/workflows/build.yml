name: Build
on:
  push:
    branches:
      - master
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-android:
    name: Build App
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm Store Directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm Cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Create Environment File
        run: |
          cat > .env << EOF
          MYANIMELIST_CLIENT_ID=${{ vars.MYANIMELIST_CLIENT_ID }}
          ANILIST_CLIENT_ID=${{ vars.ANILIST_CLIENT_ID }}
          GIT_HASH=$(git rev-parse --short HEAD)
          RELEASE_DATE=$(date --utc +'%d/%m/%y %I:%M %p %Z')
          BUILD_TYPE=Github Action
          EOF

      - name: Make Gradlew Executable
        run: cd android && chmod +x ./gradlew

      - name: Set Environment Variables
        run: |
          set -x
          echo "COMMIT_COUNT=$(git rev-list --count HEAD)" >> $GITHUB_ENV
          echo "COMMIT_ID=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Build Android Release
        env:
          COMMIT_COUNT: ${{ env.COMMIT_COUNT }}
          COMMIT_ID: ${{ env.COMMIT_ID }}
        run: |
          sed -i 's/LNReader/LNReader-r${{ env.COMMIT_COUNT }}(${{ env.COMMIT_ID }})/g' android/app/src/main/res/values/strings.xml
          cd android && ./gradlew assembleRelease -PcustomAppId=com.rajarsheechatterjee.LNReader.commit_${{ env.COMMIT_ID }} --build-cache
          mv app/build/outputs/apk/release/app-release.apk app/build/outputs/apk/release/LNReader-r${{ env.COMMIT_COUNT }}-${{ env.COMMIT_ID }}.apk

      - name: Upload Release Artifact
        env:
          COMMIT_COUNT: ${{ env.COMMIT_COUNT }}
          COMMIT_ID: ${{ env.COMMIT_ID }}
        uses: actions/upload-artifact@v4
        with:
          name: LNReader-r${{ env.COMMIT_COUNT }}-${{ env.COMMIT_ID }}
          path: android/app/build/outputs/apk/release/LNReader-r${{ env.COMMIT_COUNT }}-${{ env.COMMIT_ID }}.apk
          retention-days: 30

  build-ios:
    name: Build Unsigned iOS IPA
    runs-on: macos-latest
    timeout-minutes: 60
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Get pnpm Store Directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm Cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Create Environment File
        run: |
          cat > .env << EOF
          MYANIMELIST_CLIENT_ID=${{ vars.MYANIMELIST_CLIENT_ID }}
          ANILIST_CLIENT_ID=${{ vars.ANILIST_CLIENT_ID }}
          GIT_HASH=$(git rev-parse --short HEAD)
          RELEASE_DATE=$(date -u +'%d/%m/%y %I:%M %p %Z')
          BUILD_TYPE=Github Action
          EOF

      - name: Expo Prebuild
        run: npx expo prebuild -p ios --non-interactive

      - name: Configure Unsigned Build
        run: |
          cd ios
          
          # 1. Disable signing in project.pbxproj
          sed -i '' 's/CODE_SIGNING_ALLOWED = YES/CODE_SIGNING_ALLOWED = NO/g' LNReader.xcodeproj/project.pbxproj
          sed -i '' 's/CODE_SIGNING_REQUIRED = YES/CODE_SIGNING_REQUIRED = NO/g' LNReader.xcodeproj/project.pbxproj
          
          # 2. Modify Podfile to disable signing for pods
          python3 -c "
          import os
          path = 'Podfile'
          with open(path, 'r') as f:
              content = f.read()
          
          fix_code = '''
              installer.pods_project.targets.each do |target|
                target.build_configurations.each do |config|
                  config.build_settings['GCC_OPTIMIZATION_LEVEL'] = '0'
                  config.build_settings['SWIFT_OPTIMIZATION_LEVEL'] = '-Onone'
                  config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'
                  config.build_settings['CODE_SIGNING_REQUIRED'] = 'NO'
                  config.build_settings['ENABLE_BITCODE'] = 'NO'
                end
              end
          '''
          if 'post_install do |installer|' in content:
              new_content = content.replace('post_install do |installer|', 'post_install do |installer|' + fix_code)
              with open(path, 'w') as f:
                  f.write(new_content)
          "

      - name: Install Pods
        run: |
          cd ios
          pod install

      - name: Build iOS App
        run: |
          cd ios
          xcodebuild build \
            -workspace LNReader.xcworkspace \
            -scheme LNReader \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            -derivedDataPath build_output \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            AD_HOC_CODE_SIGNING_ALLOWED=YES \
            COMPILER_INDEX_STORE_ENABLE=NO

      - name: Create IPA
        run: |
          cd ios
          APP_PATH=$(find build_output -name "*.app" -type d | head -n 1)
          if [ -z "$APP_PATH" ]; then
            echo "❌ App not found"
            exit 1
          fi
          
          echo "✅ Found app at: $APP_PATH"
          mkdir -p Payload
          cp -R "$APP_PATH" Payload/
          zip -r LNReader-unsigned.ipa Payload

      - name: Set Environment Variables
        run: |
          echo "COMMIT_COUNT=$(git rev-list --count HEAD)" >> $GITHUB_ENV
          echo "COMMIT_ID=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Upload Release Artifact
        uses: actions/upload-artifact@v4
        with:
          name: LNReader-iOS-r${{ env.COMMIT_COUNT }}-${{ env.COMMIT_ID }}
          path: ios/LNReader-unsigned.ipa
          retention-days: 30
